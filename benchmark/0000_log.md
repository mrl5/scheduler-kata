# Benchmark no. 0000

Captured state for commit
[7adc5dacb8](https://github.com/mrl5/scheduler-kata/tree/7adc5dacb81bf42af19d5390f1127b255c397a55)


## Content
* [Main focus](#main-focus)
* [Description](#description)
* [OS](#os)
* [Hardware](#hardware)
* [Setup](#setup)
* [Predicate 0](#predicate-0)
* [Predicate 1](#predicate-1)
* [Predicate 2](#predicate-2)
* [Predicate 3](#predicate-3)
* [Predicate 4](#predicate-4)
* [Further investigation](#further-investigation)
* [Additional notes](#additional-notes)


## Main focus
Database


## Description
Analyze query performance when both REST API and WORKERS are running


### Refs
* https://www.crunchydata.com/developers/playground/query-performance-analytics


## OS
```console
grep PRETTY_NAME /etc/os-release
```
```
PRETTY_NAME="Debian GNU/Linux 11 (bullseye)"
```
```console
uname -a
```
```
Linux debian 5.10.0-23-amd64 #1 SMP Debian 5.10.179-1 (2023-05-12) x86_64 GNU/Linux
```


## Hardware
```console
lscpu
```
```
Architecture:                    x86_64
CPU op-mode(s):                  32-bit, 64-bit
Byte Order:                      Little Endian
<REDACTED>
CPU(s):                          16
<REDACTED>
Model name:                      AMD Ryzen 7 3700X 8-Core Processor
<REDACTED>
```
```console
lsmem | grep -i 'total online'
```
```
Total online memory:      32G
```
```console
lspci  | grep -i nvm
```
```
Non-Volatile memory controller: Samsung Electronics Co Ltd NVMe SSD Controller SM981/PM981/PM983
```


## Setup
1. Fresh setup
```console
sudo rm -rf /var/lib/docker
just db-only
just db-bootstrap
just db-add-new-tenant db-migrate
```

2. Spin up containers
```console
cp -v benchmark/0000_env/docker-compose.yml .
cp -v benchmark/0000_env/.env .
just build run
```

3. Some observability
```console
htop
watch -n 1 "./benchmark/0000_env/monitor.sh >> benchmark/0000_env/0000_monitor.log"
export PGPASSWORD=changeme1
watch "psql -h localhost -U postgres -d scheduler-kata \
    -c 'SELECT task_id, is_running FROM tenant_default.queue WHERE is_running'"
```

4. Start benchmark
```console
bash ./benchmark/0000_env/bench.sh
```

5. Stop containers once there is no active task in queue

6. Run db and check predicates
```
just db-only
psql -h localhost -U postgres -d scheduler-kata
```

## Predicate 0
### Basic Linux monitoring
1. `bench.sh` execution time - this measures duration of API calls, not workers time
```
real	3m13.885s
user	0m1.149s
sys	0m0.488s
```
2. Top CPU usage
```
CPU: 10%
```
3. Top memory used
```
used
958748
```

## Predicate 1
### Most time consuming queries
```
\x on
```
```sql
SELECT
  d.datname, round(s.total_exec_time::numeric, 2) AS total_exec_time, s.calls, s.rows,
  round(s.total_exec_time::numeric / calls, 2) AS avg_time,
  round((100 * s.total_exec_time / sum(s.total_exec_time::numeric) OVER ())::numeric, 2) AS percentage_cpu,
  substring(s.query, 1, 500) AS short_query
FROM pg_stat_statements s JOIN pg_database d ON (s.dbid = d.oid)
ORDER BY percentage_cpu DESC
LIMIT 5;
```
```
-[ RECORD 1 ]---+---------------------------------------------------------------------------
datname         | scheduler-kata
total_exec_time | 5499.03
calls           | 210006
rows            | 300
avg_time        | 0.03
percentage_cpu  | 90.93
short_query     | WITH t AS (                                                               +
                |             SELECT task_id as id, task_created_at AS created_at FROM queue+
                |             WHERE is_running = $1 AND not_before <= now()                 +
                |             LIMIT $2 FOR UPDATE SKIP LOCKED                               +
                |         ) UPDATE queue SET is_running = $3 FROM t                         +
                |         WHERE (task_id, task_created_at) = (t.id, t.created_at)           +
                |         RETURNING task_id, task_created_at
-[ RECORD 2 ]---+---------------------------------------------------------------------------
datname         | scheduler-kata
total_exec_time | 137.97
calls           | 600
rows            | 3860
avg_time        | 0.23
percentage_cpu  | 2.28
short_query     | SELECT                                                                    +
                |             id,                                                           +
                |             typ,                                                          +
                |             state                                                         +
                |         FROM task_state                                                   +
                |          WHERE state = $1 ORDER BY id desc LIMIT $2
-[ RECORD 3 ]---+---------------------------------------------------------------------------
datname         | scheduler-kata
total_exec_time | 74.86
calls           | 200
rows            | 1200
avg_time        | 0.37
percentage_cpu  | 1.24
short_query     | SELECT                                                                    +
                |             id,                                                           +
                |             typ,                                                          +
                |             state                                                         +
                |         FROM task_state                                                   +
                |          ORDER BY id desc LIMIT $1
-[ RECORD 4 ]---+---------------------------------------------------------------------------
datname         | scheduler-kata
total_exec_time | 74.46
calls           | 300
rows            | 2975
avg_time        | 0.25
percentage_cpu  | 1.23
short_query     | SELECT                                                                    +
                |             id,                                                           +
                |             typ,                                                          +
                |             state                                                         +
                |         FROM task_state                                                   +
                |          WHERE typ = $1 ORDER BY id desc LIMIT $2
-[ RECORD 5 ]---+---------------------------------------------------------------------------
datname         | scheduler-kata
total_exec_time | 69.88
calls           | 117
rows            | 400
avg_time        | 0.60
percentage_cpu  | 1.16
short_query     | INSERT INTO queue (task_id, task_created_at, not_before)                  +
                |         SELECT id, created_at,                                            +
                |             CASE                                                          +
                |                 WHEN not_before IS NULL                                   +
                |                     THEN created_at                                       +
                |                 ELSE not_before                                           +
                |             END                                                           +
                |         FROM task_state WHERE state = $1::text                            +
                |         ORDER BY id asc LIMIT $2                                          +
                |         ON CONFLICT DO NOTHING

```


## Predicate 2
### Average Query Execution Time
```sql
SELECT (sum(total_exec_time) / sum(calls))::numeric(6,3) AS avg_execution_time
FROM pg_stat_statements;
```
```
-[ RECORD 1 ]------+------
avg_execution_time | 0.028
```


## Predicate 3
### Queries that write the most to shared_buffers
```sql
SELECT query, shared_blks_dirtied
FROM pg_stat_statements
WHERE shared_blks_dirtied > 0
ORDER BY 2 desc
LIMIT 5;
```
```
-[ RECORD 1 ]-------+----------------------------------------------------------------------------------------------------------------
query               | INSERT INTO task (                                                                                             +
                    |             id,                                                                                                +
                    |             typ,                                                                                               +
                    |             not_before                                                                                         +
                    |         )                                                                                                      +
                    |         VALUES (                                                                                               +
                    |             $1,                                                                                                +
                    |             $2,                                                                                                +
                    |             $3                                                                                                 +
                    |         )                                                                                                      +
                    |         RETURNING id
shared_blks_dirtied | 36
-[ RECORD 2 ]-------+----------------------------------------------------------------------------------------------------------------
query               | INSERT INTO queue (task_id, task_created_at, not_before)                                                       +
                    |         SELECT id, created_at,                                                                                 +
                    |             CASE                                                                                               +
                    |                 WHEN not_before IS NULL                                                                        +
                    |                     THEN created_at                                                                            +
                    |                 ELSE not_before                                                                                +
                    |             END                                                                                                +
                    |         FROM task_state WHERE state = $1::text                                                                 +
                    |         ORDER BY id asc LIMIT $2                                                                               +
                    |         ON CONFLICT DO NOTHING
shared_blks_dirtied | 8
-[ RECORD 3 ]-------+----------------------------------------------------------------------------------------------------------------
<REDACTED> pg_cron related
-[ RECORD 4 ]-------+----------------------------------------------------------------------------------------------------------------
<REDACTED> pg_cron related
-[ RECORD 5 ]-------+----------------------------------------------------------------------------------------------------------------
<REDACTED> pg_cron related
```


## Predicate 4
### Tables that might be needing an index
```sql
SELECT relname, seq_scan - idx_scan AS too_much_seq,
    CASE WHEN seq_scan - idx_scan > 0 THEN 'Missing Index?' ELSE 'OK' END,
    pg_relation_size(relid) AS rel_size, seq_scan, idx_scan
FROM pg_stat_user_tables
WHERE schemaname <> 'information_schema' AND schemaname NOT LIKE 'pg%'
ORDER BY too_much_seq DESC;
```
```
-[ RECORD 1 ]+-----------------
relname      | queue
too_much_seq | 399709
case         | Missing Index?
rel_size     | 32768
seq_scan     | 400534
idx_scan     | 825
-[ RECORD 2 ]+-----------------
relname      | tenant
too_much_seq | 28
case         | Missing Index?
rel_size     | 8192
seq_scan     | 28
idx_scan     | 0
-[ RECORD 3 ]+-----------------
<REDACTED> pg_cron related table
-[ RECORD 4 ]+-----------------
relname      | task
too_much_seq | 0
case         | OK
rel_size     | 0
seq_scan     | 0
idx_scan     | 0
-[ RECORD 5 ]+-----------------
<REDACTED> sqlx related table
-[ RECORD 6 ]+-----------------
<REDACTED> pg_cron related table
-[ RECORD 7 ]+-----------------
relname      | task_y2023m07
too_much_seq | -331
case         | OK
rel_size     | 180224
seq_scan     | 2273
idx_scan     | 2604
-[ RECORD 8 ]+-----------------
relname      | task_y2023m08
too_much_seq | -2945
case         | OK
rel_size     | 0
seq_scan     | 604
idx_scan     | 3549
```


## Further investigation
```
\x off
```
```sql
EXPLAIN ANALYZE
        WITH t AS (
            SELECT task_id as id, task_created_at AS created_at FROM tenant_default.queue
            WHERE is_running = false AND not_before <= now()
            LIMIT 1 FOR UPDATE SKIP LOCKED
        ) UPDATE tenant_default.queue SET is_running = true FROM t
        WHERE (task_id, task_created_at) = (t.id, t.created_at)
        RETURNING task_id, task_created_at;
```
```
                                                         QUERY PLAN                                                         
----------------------------------------------------------------------------------------------------------------------------
 Update on queue  (cost=5.54..11.30 rows=1 width=55) (actual time=0.033..0.035 rows=0 loops=1)
   CTE t
     ->  Limit  (cost=0.00..5.51 rows=1 width=30) (actual time=0.020..0.020 rows=0 loops=1)
           ->  LockRows  (cost=0.00..5.51 rows=1 width=30) (actual time=0.019..0.019 rows=0 loops=1)
                 ->  Seq Scan on queue queue_1  (cost=0.00..5.50 rows=1 width=30) (actual time=0.019..0.019 rows=0 loops=1)
                       Filter: ((NOT is_running) AND (not_before <= now()))
                       Rows Removed by Filter: 100
   ->  Hash Join  (cost=0.04..5.79 rows=1 width=55) (actual time=0.032..0.033 rows=0 loops=1)
         Hash Cond: ((queue.task_id = t.id) AND (queue.task_created_at = t.created_at))
         ->  Seq Scan on queue  (cost=0.00..5.00 rows=100 width=30) (actual time=0.007..0.007 rows=1 loops=1)
         ->  Hash  (cost=0.02..0.02 rows=1 width=72) (actual time=0.021..0.021 rows=0 loops=1)
               Buckets: 1024  Batches: 1  Memory Usage: 8kB
               ->  CTE Scan on t  (cost=0.00..0.02 rows=1 width=72) (actual time=0.020..0.020 rows=0 loops=1)
 Planning Time: 0.182 ms
 Execution Time: 0.072 ms
(15 rows)
```


## Additional notes

I see many warnings in logs:
```
WARN sqlx::query: summary="WITH t AS ( …" db.statement="\n\nWITH t AS (\n  SELECT\n    task_id as id,\n    task_created_at AS created_at\n  FROM\n    queue\n  WHERE\n    is_running = false\n    AND not_before <= now()\n  LIMIT\n    1 FOR\n  UPDATE\n    SKIP LOCKED\n)\nUPDATE\n  queue\nSET\n  is_running = true\nFROM\n  t\nWHERE\n  (task_id, task_created_at) = (t.id, t.created_at) RETURNING task_id,\n  task_created_at\n" rows_affected=0 rows_returned=1 elapsed=1.985186222s
```
sometimes elapsed is around **4 seconds !!!**

### Hypothesis
1. Maybe there are some locks in Postgres that are not seen in `pg_stat_statements`?
